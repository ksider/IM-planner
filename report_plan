Пошаговый план разработки (внедрение по этапам)

Этап 0. Подготовка
1. Зафиксировать env-переменные: ADMIN_EMAIL, ADMIN_TEMP_PASSWORD, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, SESSION_SECRET.
2. Определить начальные protected‑routes (страницы и API).
3. Утвердить названия таблиц и полей (users, admin_settings, sessions, audit_log).

Этап 1. База данных и первый админ
1. Добавить миграции для таблиц users, admin_settings, sessions, audit_log.
2. Реализовать скрипт создания первого админа при старте (если отсутствует).
3. Добавить флаг temp_password и проверку “нужно сменить пароль”.

Этап 2. Сессии и локальный логин
1. Подключить session store (SQLite) и Passport local strategy.
2. Реализовать POST /auth/login и POST /auth/logout.
3. Middleware проверки аутентификации для защищённых маршрутов.
4. Экран логина + обработка ошибок.

Этап 3. Смена временного пароля
1. Экран смены пароля (обязательный при temp_password=true).
2. POST /auth/change-password.
3. Снять temp_password после успешной смены.

Этап 4. Google OAuth с доменным ограничением
1. Подключить passport-google-oauth20.
2. Реализовать /auth/google и /auth/google/callback.
3. Проверка hd/email домена против admin_settings.allowed_domain.
4. Связать или создать пользователя по google_sub/email.

Этап 5. Админка и управление доменом
1. Страница админки (доступ только admin).
2. Настройка allowed_domain через UI.
3. Запись изменений в audit_log.

Этап 6. Управление пользователями
1. Таблица пользователей (list + search).
2. Редактирование пользователя (email/статус/role placeholder).
3. Бан и удаление пользователя.
4. Forced‑logout: удаление активных сессий.
5. Audit log на все действия.

Этап 7. Безопасность
1. Rate limit для /auth/login.
2. Secure/HttpOnly cookies, SameSite=Lax.
3. HTTPS (dev: mkcert или self‑signed; prod: reverse‑proxy/managed).

Этап 8. Тестирование
1. Unit: доменная проверка, bcrypt, temp_password.
2. Integration: login/logout, google callback, ban+forced logout.
3. Admin: CRUD пользователей, домен.

Этап 9. Подготовка к ролям (этап 2)
1. Оставить поле role.
2. Спланировать role‑guard middleware и матрицу доступа.

Этап 10. Связь экспериментов с пользователями (этап 2)
1. Добавить поле owner_user_id в experiments (с FK на users).
2. Заполнять owner_user_id при создании эксперимента.
3. Ограничить просмотр/редактирование экспериментов владельцем (или ролью выше).
4. Админ (или спец‑роль) может переназначить владельца.
