<%- include("partials/head", { title: title }) %>
<%- include("partials/nav", { currentUser: currentUser }) %>
<div class="container">
  <div class="card">
    <h2 class="card-title">Admin Settings</h2>
    <div class="admin-actions">
      <button class="icon-btn icon-only" type="button" id="openSettingsDialog" title="Settings">
        <span class="material-symbols-rounded" aria-hidden="true">settings</span>
      </button>
      <button class="icon-btn icon-only" type="button" id="openAddUserDialog" title="Add user">
        <span class="material-symbols-rounded" aria-hidden="true">person_add</span>
      </button>
      <a class="icon-btn icon-only" href="/audit" title="Audit log">
        <span class="material-symbols-rounded" aria-hidden="true">fact_check</span>
      </a>
    </div>
  </div>

  <div class="card">
    <h2 class="card-title">Users</h2>
    <% if (notice) { %>
      <div class="toast toast-success toast-inline">
        <span><%= notice %></span>
        <button type="button" class="toast-close" aria-label="Close">×</button>
      </div>
    <% } %>
    <% if (error) { %>
      <div class="toast toast-error toast-inline">
        <span><%= error %></span>
        <button type="button" class="toast-close" aria-label="Close">×</button>
      </div>
    <% } %>
    <div id="adminToastArea"></div>
    <div class="table-wrap">
      <table class="pure-table pure-table-striped">
        <thead>
          <tr>
            <th>User</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(function(user) { %>
            <tr class="<%= user.status === 'DISABLED' ? 'row-banned' : '' %>">
              <td>
                <div class="pure-form inline-form">
                  <span class="status-dot <%= user.status === 'ACTIVE' ? 'online' : 'offline' %>" title="<%= user.status %>"></span>
                  <input name="name" type="text" value="<%= user.name ?? '' %>" placeholder="Name" form="userForm-<%= user.id %>" data-autosave="userForm-<%= user.id %>">
                  <input name="email" type="email" value="<%= user.email %>" form="userForm-<%= user.id %>" data-autosave="userForm-<%= user.id %>">
                </div>
              </td>
              <td>
                <div class="pure-form inline-form">
                  <select name="role" form="userForm-<%= user.id %>" data-autosave="userForm-<%= user.id %>">
                  <option value="" <%= !user.role ? 'selected' : '' %>>none</option>
                  <option value="admin" <%= user.role === 'admin' ? 'selected' : '' %>>admin</option>
                  <option value="manager" <%= user.role === 'manager' ? 'selected' : '' %>>manager</option>
                  <option value="engineer" <%= user.role === 'engineer' ? 'selected' : '' %>>engineer</option>
                  <option value="operator" <%= user.role === 'operator' ? 'selected' : '' %>>operator</option>
                  <option value="viewer" <%= user.role === 'viewer' ? 'selected' : '' %>>viewer</option>
                  </select>
                </div>
              </td>
              <td>
                <form id="userForm-<%= user.id %>" method="post" action="/admin/users/<%= user.id %>" class="pure-form inline-form autosave-form ajax-form"></form>
                <form method="post" action="/admin/users/<%= user.id %>/reset-password" class="pure-form inline-form reset-form">
                  <input type="hidden" name="email" value="<%= user.email %>">
                  <button type="submit" class="icon-btn icon-only reset-btn" title="Reset password">
                    <span class="material-symbols-rounded" aria-hidden="true">restart_alt</span>
                    <% if (user.reset_requested_at) { %>
                      <span class="alert-dot" title="Reset requested"></span>
                    <% } %>
                  </button>
                  <div class="reset-toast" hidden>
                    <span class="reset-text"></span>
                    <button type="button" class="reset-close">×</button>
                  </div>
                </form>
                <% if (user.status === 'DISABLED') { %>
                  <form method="post" action="/admin/users/<%= user.id %>/unban" class="pure-form inline-form ajax-form">
                    <button type="submit" class="icon-btn icon-only" title="Unban user" data-ban-toggle="unban">
                      <span class="material-symbols-rounded" aria-hidden="true">lock_open</span>
                    </button>
                  </form>
                <% } else { %>
                  <form method="post" action="/admin/users/<%= user.id %>/ban" class="pure-form inline-form ajax-form">
                    <button type="submit" class="icon-btn icon-only warn" title="Ban user" data-ban-toggle="ban">
                      <span class="material-symbols-rounded" aria-hidden="true">block</span>
                    </button>
                  </form>
                <% } %>
                <form method="post" action="/admin/users/<%= user.id %>/force-logout" class="pure-form inline-form ajax-form">
                  <button type="submit" class="icon-btn icon-only" title="Force logout">
                    <span class="material-symbols-rounded" aria-hidden="true">logout</span>
                  </button>
                </form>
                <form method="post" action="/admin/users/<%= user.id %>/delete" class="pure-form inline-form ajax-form" onsubmit="return confirm('Delete user?');">
                  <button type="submit" class="icon-btn icon-only danger" title="Delete user">
                    <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                  </button>
                </form>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2 class="card-title">Experiments</h2>
    <div class="tab-row">
      <button class="tab-btn is-active" type="button" data-exp-tab="active">Active</button>
      <button class="tab-btn" type="button" data-exp-tab="archived">Archived</button>
    </div>
    <div id="adminExperimentToastArea"></div>
    <div class="table-wrap">
      <table class="pure-table pure-table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Owner</th>
            <th>Status</th>
            <th>Progress</th>
          </tr>
        </thead>
        <tbody>
          <% experiments.forEach(function(exp) { %>
            <tr data-exp-id="<%= exp.id %>" data-exp-status="<%= exp.archived_at ? 'archived' : 'active' %>">
              <td><%= exp.id %></td>
              <td><a href="/experiments/<%= exp.id %>"><%= exp.name %></a></td>
              <td>
                <% if (exp.archived_at) { %>
                  <form method="post" action="/admin/experiments/<%= exp.id %>/restore" class="pure-form inline-form ajax-form" data-exp-action="restore">
                    <select name="owner_user_id">
                      <option value="">No owner</option>
                      <% users.forEach(function(user) { %>
                        <option value="<%= user.id %>" <%= exp.owner_user_id === user.id ? 'selected' : '' %>>
                          <%= user.name ? user.name : user.email %>
                        </option>
                      <% }); %>
                    </select>
                    <button type="submit" class="pure-button">Restore</button>
                  </form>
                <% } else { %>
                <form method="post" action="/admin/experiments/<%= exp.id %>/owner" class="pure-form inline-form ajax-form autosave-form" data-exp-action="owner-update">
                  <select name="owner_user_id">
                    <option value="">No owner</option>
                    <% users.forEach(function(user) { %>
                      <option value="<%= user.id %>" <%= exp.owner_user_id === user.id ? 'selected' : '' %>>
                        <%= user.name ? user.name : user.email %>
                      </option>
                    <% }); %>
                  </select>
                </form>
                <% } %>
              </td>
              <td data-exp-status-cell>
                <% if (exp.archived_at) { %>
                  <form method="post" action="/admin/experiments/<%= exp.id %>/delete" class="pure-form inline-form ajax-form" data-exp-action="delete" onsubmit="return confirm('Delete this archived experiment? This cannot be undone.');">
                    <button type="submit" class="icon-btn icon-only danger" title="Delete permanently">
                      <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                    </button>
                  </form>
                <% } else { %>
                  <form method="post" action="/experiments/<%= exp.id %>/archive" class="pure-form inline-form ajax-form" data-exp-action="archive" onsubmit="return confirm('Archive this experiment?');">
                    <button type="submit" class="icon-btn icon-only warn" title="Archive">
                      <span class="material-symbols-rounded" aria-hidden="true">archive</span>
                    </button>
                  </form>
                <% } %>
              </td>
              <td><span class="status-pill status-<%= exp.status %>"><%= exp.statusLabel %></span></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>
<%- include("partials/foot") %>

<dialog class="modal-frame" id="settingsDialog">
  <div class="modal-header">
    <strong>Settings</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <div class="modal-body">
    <form method="post" action="/admin/domain" class="pure-form ajax-form">
      <label for="allowed_domain">Allowed Google domain</label>
      <input id="allowed_domain" name="allowed_domain" type="text" value="<%= settings.allowed_domain ?? '' %>" placeholder="example.com">
      <button type="submit" class="pure-button pure-button-primary">Save</button>
    </form>
    <form method="post" action="/admin/https" class="pure-form ajax-form">
      <label class="pure-checkbox">
        <input type="checkbox" name="require_https" <%= settings.require_https ? 'checked' : '' %>>
        Require HTTPS (only useful behind a reverse proxy)
      </label>
      <button type="submit" class="pure-button">Update</button>
    </form>
  </div>
</dialog>

<dialog class="modal-frame" id="addUserDialog">
  <div class="modal-header">
    <strong>Add User</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <div class="modal-body">
    <form method="post" action="/admin/users" class="pure-form pure-form-stacked">
      <label for="new_user_name">Name</label>
      <input id="new_user_name" name="name" type="text" placeholder="User name">
      <label for="new_user_email">Email</label>
      <input id="new_user_email" name="email" type="email" placeholder="user@example.com" required>
      <label for="new_user_role">Role</label>
      <select id="new_user_role" name="role">
        <option value="">role (optional)</option>
        <option value="admin">admin</option>
        <option value="manager">manager</option>
        <option value="engineer">engineer</option>
        <option value="operator">operator</option>
        <option value="viewer">viewer</option>
      </select>
      <label for="new_user_status">Status</label>
      <select id="new_user_status" name="status">
        <option value="ACTIVE">ACTIVE</option>
        <option value="DISABLED">DISABLED</option>
      </select>
      <button type="submit" class="pure-button pure-button-primary">Create</button>
    </form>
    <p class="muted">If email is not configured, the temporary password will be shown after creation.</p>
  </div>
</dialog>

<script>
  const settingsDialog = document.getElementById('settingsDialog');
  const addUserDialog = document.getElementById('addUserDialog');
  document.getElementById('openSettingsDialog')?.addEventListener('click', () => settingsDialog?.showModal());
  document.getElementById('openAddUserDialog')?.addEventListener('click', () => addUserDialog?.showModal());
  document.querySelectorAll('[data-close]').forEach((btn) => {
    btn.addEventListener('click', () => {
      settingsDialog?.close();
      addUserDialog?.close();
    });
  });


  // Auto-save admin edits (except user creation).
  const autosaveTimers = new Map();
  const scheduleAutosave = (form) => {
    if (!form) return;
    const existing = autosaveTimers.get(form);
    if (existing) clearTimeout(existing);
    const timer = setTimeout(async () => {
      const payload = new URLSearchParams(new FormData(form));
      const resp = await fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'fetch'
        },
        body: payload
      });
      if (!resp.ok) {
        const target = form?.getAttribute('data-exp-action') ? 'experiments' : 'users';
        showToast('Save failed', 'error', target);
      }
    }, 400);
    autosaveTimers.set(form, timer);
  };
  document.querySelectorAll('[data-autosave]').forEach((field) => {
    field.addEventListener('change', () => {
      const formId = field.getAttribute('data-autosave');
      const form = formId ? document.getElementById(formId) : null;
      scheduleAutosave(form);
    });
  });
  const bindAutosaveSelects = (root = document) => {
    root.querySelectorAll('form.autosave-form select').forEach((select) => {
      if (select.dataset.autosaveBound === '1') return;
      select.dataset.autosaveBound = '1';
      select.addEventListener('change', () => {
        const form = select.closest('form');
        scheduleAutosave(form);
      });
    });
  };
  bindAutosaveSelects();

  const toastArea = document.getElementById('adminToastArea');
  const expToastArea = document.getElementById('adminExperimentToastArea');
  const showToast = (message, kind = 'success', target = 'users') => {
    const area = target === 'experiments' ? expToastArea : toastArea;
    if (!area) return;
    const toast = document.createElement('div');
    toast.className = `toast toast-${kind} toast-inline`;
    toast.innerHTML = `<span>${message}</span><button type="button" class="toast-close" aria-label="Close">×</button>`;
    area.appendChild(toast);
    toast.querySelector('.toast-close')?.addEventListener('click', () => toast.remove());
    setTimeout(() => toast.remove(), 4000);
  };

  const bindAjaxForms = (root = document) => {
    root.querySelectorAll('.ajax-form').forEach((form) => {
      if (form.dataset.ajaxBound === '1') return;
      form.dataset.ajaxBound = '1';
      form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const expAction = form.getAttribute('data-exp-action');
      const isExperiment = Boolean(expAction);
      const banToggle = form.querySelector('[data-ban-toggle]');
      const payload = new URLSearchParams(new FormData(form));
      const resp = await fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'fetch'
        },
        body: payload
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) {
        showToast(data?.message || 'Action failed', 'error', isExperiment ? 'experiments' : 'users');
        return;
      }
      showToast(data?.message || 'Saved', 'success', isExperiment ? 'experiments' : 'users');
      if (isExperiment) {
        const row = form.closest('tr[data-exp-status]');
        if (expAction === 'delete' && row) {
          row.remove();
          return;
        }
        if (expAction === 'restore' && row) {
          row.dataset.expStatus = 'active';
          switchRowToActive(row);
          setExpTab('active');
        }
        if (expAction === 'archive' && row) {
          row.dataset.expStatus = 'archived';
          switchRowToArchived(row);
          setExpTab('archived');
        }
      }
      if (banToggle) {
        const isBan = banToggle.dataset.banToggle === 'ban';
        const nextIsBan = !isBan;
        const icon = banToggle.querySelector('.material-symbols-rounded');
        if (nextIsBan) {
          banToggle.dataset.banToggle = 'ban';
          banToggle.title = 'Ban user';
          banToggle.classList.add('warn');
          if (icon) icon.textContent = 'block';
          form.action = form.action.replace(/\/unban$/, '/ban');
        } else {
          banToggle.dataset.banToggle = 'unban';
          banToggle.title = 'Unban user';
          banToggle.classList.remove('warn');
          if (icon) icon.textContent = 'lock_open';
          form.action = form.action.replace(/\/ban$/, '/unban');
        }
      }
    });
    });
  };
  // AJAX actions to avoid query params.
  bindAjaxForms();

  // Inline reset password response.
  document.querySelectorAll('.reset-form').forEach((form) => {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = new URLSearchParams(new FormData(form));
      const resp = await fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'fetch'
        },
        body: payload
      });
      if (!resp.ok) {
        alert('Reset failed');
        return;
      }
      const data = await resp.json();
      const toast = form.querySelector('.reset-toast');
      const text = form.querySelector('.reset-text');
      if (!toast || !text) return;
      text.textContent = `Temp password: ${data.tempPassword}`;
      toast.hidden = false;
      showToast(data?.message || 'Temporary password generated', 'success');
    });
  });
  document.querySelectorAll('.reset-close').forEach((btn) => {
    btn.addEventListener('click', () => {
      const toast = btn.closest('.reset-toast');
      if (toast) toast.hidden = true;
    });
  });

  // Experiments tabs (active/archived).
  const expTabButtons = document.querySelectorAll('[data-exp-tab]');
  const buildArchiveForm = (experimentId) => {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/experiments/${experimentId}/archive`;
    form.className = 'pure-form inline-form ajax-form';
    form.setAttribute('data-exp-action', 'archive');
    form.onsubmit = () => confirm('Archive this experiment?');
    form.innerHTML = `
      <button type="submit" class="icon-btn icon-only warn" title="Archive">
        <span class="material-symbols-rounded" aria-hidden="true">archive</span>
      </button>
    `;
    return form;
  };
  const buildDeleteForm = (experimentId) => {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/admin/experiments/${experimentId}/delete`;
    form.className = 'pure-form inline-form ajax-form';
    form.setAttribute('data-exp-action', 'delete');
    form.onsubmit = () => confirm('Delete this archived experiment? This cannot be undone.');
    form.innerHTML = `
      <button type="submit" class="icon-btn icon-only danger" title="Delete permanently">
        <span class="material-symbols-rounded" aria-hidden="true">delete</span>
      </button>
    `;
    return form;
  };
  const switchRowToArchived = (row) => {
    const experimentId = row.dataset.expId;
    const ownerForm = row.querySelector('form[data-exp-action="owner-update"]');
    if (ownerForm && experimentId) {
      ownerForm.classList.remove('autosave-form');
      ownerForm.setAttribute('data-exp-action', 'restore');
      ownerForm.action = `/admin/experiments/${experimentId}/restore`;
      let button = ownerForm.querySelector('button[type="submit"]');
      if (!button) {
        button = document.createElement('button');
        button.type = 'submit';
        button.className = 'pure-button';
        ownerForm.appendChild(button);
      }
      button.textContent = 'Restore';
    }
    const statusCell = row.querySelector('[data-exp-status-cell]');
    if (statusCell && experimentId) {
      statusCell.innerHTML = '';
      statusCell.appendChild(buildDeleteForm(experimentId));
      bindAjaxForms(statusCell);
    }
  };
  const switchRowToActive = (row) => {
    const experimentId = row.dataset.expId;
    const ownerForm = row.querySelector('form[data-exp-action="restore"]');
    if (ownerForm && experimentId) {
      ownerForm.classList.add('autosave-form');
      ownerForm.setAttribute('data-exp-action', 'owner-update');
      ownerForm.action = `/admin/experiments/${experimentId}/owner`;
      const button = ownerForm.querySelector('button[type="submit"]');
      if (button) button.remove();
      bindAutosaveSelects(ownerForm);
    }
    const statusCell = row.querySelector('[data-exp-status-cell]');
    if (statusCell && experimentId) {
      statusCell.innerHTML = '';
      statusCell.appendChild(buildArchiveForm(experimentId));
      bindAjaxForms(statusCell);
    }
  };
  const setExpTab = (tab) => {
    expTabButtons.forEach((btn) => {
      btn.classList.toggle('is-active', btn.dataset.expTab === tab);
    });
    document.querySelectorAll('tr[data-exp-status]').forEach((row) => {
      const status = row.dataset.expStatus;
      row.style.display = status === tab ? '' : 'none';
    });
  };
  expTabButtons.forEach((btn) => {
    btn.addEventListener('click', () => setExpTab(btn.dataset.expTab || 'active'));
  });
  setExpTab('active');
</script>
