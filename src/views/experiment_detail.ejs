<%- include('partials/head', { title: `IM Planner | ${experiment.name}` }) %>
<%- include('partials/nav') %>
<div class="container">
  <div class="card">
    <div class="card-header">
      <a class="back-link" href="/" aria-label="Back to experiments">
        <span class="material-symbols-rounded" aria-hidden="true">arrow_back</span>
      </a>
      <div>
        <h1 class="card-title"><%- formatInline(experiment.name) %></h1>
        <% if (experiment.notes) { %>
          <p class="small-note"><%- formatInline(experiment.notes) %></p>
        <% } %>
      </div>
      <div class="section-actions">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Experiment</h2>
      <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
        <button class="icon-button" type="button" id="openMachineEdit" title="Edit machine assignment">
          <span class="material-symbols-rounded" aria-hidden="true">edit</span>
        </button>
      <% } %>
    </div>
    <div class="setup-summary">
      <div>
        <div class="small-note">Assigned machine</div>
        <div class="setup-value">
          <%= selectedMachine ? formatInline(selectedMachine.name) : 'No machine selected' %>
        </div>
      </div>
      <div>
        <div class="small-note">Recipe</div>
        <div class="setup-value">
          <% if (recipeNames && recipeNames.length) { %>
            <%= recipeNames.map((name) => formatInline(name)).join(', ') %>
          <% } else { %>
            -
          <% } %>
        </div>
      </div>
      <div>
        <div class="small-note">Description</div>
        <div class="setup-value"><%= experiment.notes ? formatInline(experiment.notes) : '-' %></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Research Sections</h2>
    </div>
    <div class="section-list">
      <div class="section-row">
        <div>
          <a class="section-title" href="/experiments/<%= experiment.id %>/qualification"><strong>Qualification</strong></a>
          <div class="small-note">Six-step Scientific Molding sequence.</div>
        </div>
        <div class="section-actions">
          <a class="pure-button pure-button-secondary" href="/experiments/<%= experiment.id %>/qualification">Open</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/1">Step 1</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/2">Step 2</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/3">Step 3</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/4">Step 4</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/5">Step 5</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/6">Step 6</a>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Detailed Optimization</h2>
      <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
        <button class="pure-button pure-button-secondary" type="button" id="openDoeCreate">AddNew</button>
      <% } %>
    </div>
    <div class="section-list">
      <% if (!doeStudies || doeStudies.length === 0) { %>
        <div class="small-note">No detailed optimization studies yet. Create one.</div>
      <% } else { %>
        <% doeStudies.forEach((doe) => { %>
          <div class="section-row">
            <div>
              <a class="section-title" href="/experiments/<%= experiment.id %>/doe/<%= doe.id %>?tab=design"><strong><%- formatInline(doe.name) %></strong></a>
              <div class="small-note">Type: <%= doe.design_type %> Â· Seed: <%= doe.seed %></div>
            </div>
          <div class="section-actions">
            <a class="pure-button pure-button-secondary" href="/experiments/<%= experiment.id %>/doe/<%= doe.id %>?tab=analysis">Analysis</a>
            <a class="pure-button" href="/experiments/<%= experiment.id %>/doe/<%= doe.id %>?tab=runs">Runs</a>
            <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
              <form class="pure-form icon-action" action="/experiments/<%= experiment.id %>/doe/<%= doe.id %>/clone" method="post">
                <button class="icon-button" type="submit" title="Clone detailed optimization">
                  <span class="material-symbols-rounded" aria-hidden="true">content_copy</span>
                </button>
              </form>
              <form class="pure-form icon-action" action="/experiments/<%= experiment.id %>/doe/<%= doe.id %>/delete" method="post" onsubmit="return confirm('Delete this detailed optimization study?');">
                <button class="icon-button danger" type="submit" title="Delete detailed optimization">
                  <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                </button>
              </form>
            <% } %>
          </div>
          </div>
        <% }); %>
      <% } %>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Reports</h2>
    </div>
    <p class="small-note">Generate report variants for this experiment (qualification/DOE/outputs).</p>
    <div class="section-list">
      <% if (!reports || reports.length === 0) { %>
        <div class="small-note">No reports yet. Create one.</div>
      <% } else { %>
        <% reports.forEach((report) => { 
             let includeList = [];
             let doeList = [];
             if (report.include_json) {
               try { includeList = JSON.parse(report.include_json); } catch {}
             }
             if (report.doe_ids_json) {
               try { doeList = JSON.parse(report.doe_ids_json); } catch {}
             }
        %>
          <div class="section-row">
            <div>
              <a class="section-title" href="/reports/<%= report.id %>"><strong><%- formatInline(report.name) %></strong></a>
              <div class="small-note">Created: <%= new Date(report.created_at).toLocaleString() %></div>
            </div>
            <div class="section-actions">
              <a class="pure-button pure-button-secondary" href="/reports/<%= report.id %>">Open</a>
              <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
                <button
                  class="icon-button"
                  type="button"
                  title="Edit report"
                  data-report-edit
                  data-report-id="<%= report.id %>"
                  data-report-name="<%- formatInline(report.name) %>"
                  data-report-executors="<%- formatInline(report.executors || '') %>"
                  data-report-include="<%- JSON.stringify(includeList) %>"
                  data-report-doe="<%- JSON.stringify(doeList) %>"
                >
                  <span class="material-symbols-rounded" aria-hidden="true">edit</span>
                </button>
                <form class="pure-form icon-action" action="/reports/<%= report.id %>/delete" method="post" onsubmit="return confirm('Delete this report?');">
                  <button class="icon-button danger" type="submit" title="Delete report">
                    <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                  </button>
                </form>
              <% } %>
            </div>
          </div>
        <% }); %>
      <% } %>
    </div>
    <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
      <div class="section-actions" style="margin-top: 0.75rem;">
        <button class="pure-button pure-button-primary" type="button" id="openReportDialog">Generate Report</button>
      </div>
    <% } %>
  </div>
</div>

<dialog class="modal-frame" id="reportDialog">
  <div class="modal-header">
    <strong>Generate Report</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <div class="modal-body">
    <form class="pure-form form-grid" id="reportForm">
      <div>
        <label for="reportName">Report name</label>
        <input id="reportName" name="name" type="text" placeholder="Report 1">
      </div>
      <div>
        <label for="reportExecutors">Executors</label>
        <input id="reportExecutors" name="executors" type="text" placeholder="e.g. Ivan Petrov, Anna Lee">
      </div>
      <div>
        <div class="small-note">Include sections</div>
        <div class="form-row">
          <label class="toggle">
            <input type="checkbox" name="include" value="qualification" checked>
            <span class="track"></span>
            <span>Qualification (6 steps)</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="doe" id="includeDoeToggle">
            <span class="track"></span>
            <span>DOE</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="outputs">
            <span class="track"></span>
            <span>Outputs</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="defects">
            <span class="track"></span>
            <span>Defects</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="raw">
            <span class="track"></span>
            <span>Raw runs</span>
          </label>
        </div>
      </div>
      <div id="doePicker" style="display: none;">
        <label for="reportDoe">DOE studies</label>
        <select id="reportDoe" name="doe_ids" multiple size="4">
          <% doeStudies.forEach((study) => { %>
            <option value="<%= study.id %>"><%- formatInline(study.name) %> (<%= study.design_type %>)</option>
          <% }); %>
        </select>
        <div class="small-note">Select one or more DOE studies to include.</div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="pure-button pure-button-primary" type="button" id="generateReportBtn">Generate</button>
  </div>
</dialog>

<dialog class="modal-frame" id="machineEditDialog">
  <div class="modal-header">
    <strong>Edit experiment</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" action="/experiments/<%= experiment.id %>/update" method="post">
    <div class="modal-body">
      <div class="field-grid">
        <div>
          <label>Experiment name</label>
          <input type="text" name="name" value="<%- formatInline(experiment.name) %>">
        </div>
        <div>
          <label>Assigned machine</label>
          <select name="machine_id">
            <option value="">No machine</option>
            <% (machines || []).forEach((machine) => { %>
              <option value="<%= machine.id %>" <%= experiment.machine_id === machine.id ? 'selected' : '' %>>
                <%- formatInline(machine.name) %>
              </option>
            <% }); %>
          </select>
        </div>
        <div class="field-span">
          <label>Description</label>
          <textarea name="notes" rows="4" placeholder="Optional description"><%- formatInline(experiment.notes || '') %></textarea>
        </div>
        <% if (canManageOwner) { %>
          <div class="field-span">
            <label>Owner (admin/manager only)</label>
            <select name="owner_user_id" form="ownerUpdateForm">
              <option value="">No owner</option>
              <% (users || []).forEach((user) => { %>
                <option value="<%= user.id %>" <%= experiment.owner_user_id === user.id ? 'selected' : '' %>>
                  <%- formatInline(user.name ? user.name : user.email) %> (<%= user.role ?? 'no-role' %>)
                </option>
              <% }); %>
            </select>
          </div>
        <% } %>
      </div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <% if (canManageOwner) { %>
        <button class="pure-button" type="submit" form="ownerUpdateForm">Update Owner</button>
      <% } %>
      <button class="pure-button pure-button-primary" type="submit">Save</button>
    </div>
  </form>
</dialog>

<% if (canManageOwner) { %>
  <form id="ownerUpdateForm" class="pure-form" action="/experiments/<%= experiment.id %>/owner" method="post"></form>
<% } %>

<dialog class="modal-frame" id="doeCreateDialog">
  <div class="modal-header">
    <strong>New Detailed Optimization Study</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" action="/experiments/<%= experiment.id %>/doe" method="post">
    <div class="modal-body">
      <div class="field-grid">
        <div>
          <label>Name</label>
          <input name="name" placeholder="Optimization 1">
        </div>
        <div>
          <label>Design Type</label>
          <select name="design_type">
            <option value="BBD">BBD (Box-Behnken)</option>
            <option value="FFA">FFA (Full Factorial)</option>
            <option value="SCREEN">SCREEN (Sampled Factorial)</option>
            <option value="SIM" selected>SIM (Grid)</option>
          </select>
        </div>
        <div>
          <label>Seed</label>
          <input type="number" name="seed" value="42">
        </div>
        <div>
          <label>Center Points (BBD)</label>
          <input type="number" name="center_points" value="3">
        </div>
        <div>
          <label>Max Runs</label>
          <input type="number" name="max_runs" value="200">
        </div>
        <div>
          <label>Replicates</label>
          <input type="number" name="replicate_count" value="1">
        </div>
        <div>
          <label>Recipe Block</label>
          <label class="pure-checkbox">
            <input type="checkbox" name="recipe_as_block" value="1"> Use recipe as block
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Create Study</button>
    </div>
  </form>
</dialog>

<script>
  const doeCreateDialog = document.getElementById('doeCreateDialog');
  document.getElementById('openDoeCreate')?.addEventListener('click', () => doeCreateDialog?.showModal());
  const machineEditDialog = document.getElementById('machineEditDialog');
  document.getElementById('openMachineEdit')?.addEventListener('click', () => machineEditDialog?.showModal());
  const reportDialog = document.getElementById('reportDialog');
  document.getElementById('openReportDialog')?.addEventListener('click', () => reportDialog?.showModal());
  document.querySelectorAll('[data-close]').forEach((btn) => {
    btn.addEventListener('click', () => {
      doeCreateDialog?.close();
      machineEditDialog?.close();
      reportDialog?.close();
    });
  });

  const includeDoeToggle = document.getElementById('includeDoeToggle');
  const doePicker = document.getElementById('doePicker');
  includeDoeToggle?.addEventListener('change', (event) => {
    doePicker.style.display = event.target.checked ? 'block' : 'none';
  });

  const reportForm = document.getElementById('reportForm');
  const reportName = document.getElementById('reportName');
  const reportExecutors = document.getElementById('reportExecutors');
  const reportDoe = document.getElementById('reportDoe');
  let editingReportId = null;

  const parseJsonArray = (raw) => {
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  };

  document.querySelectorAll('[data-report-edit]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const include = parseJsonArray(btn.dataset.reportInclude);
      const doe = parseJsonArray(btn.dataset.reportDoe);
      editingReportId = btn.dataset.reportId || null;
      reportName.value = btn.dataset.reportName || '';
      reportExecutors.value = btn.dataset.reportExecutors || '';
      reportForm.querySelectorAll('input[name="include"]').forEach((input) => {
        input.checked = include.includes(input.value);
      });
      includeDoeToggle.checked = include.includes('doe');
      doePicker.style.display = includeDoeToggle.checked ? 'block' : 'none';
      if (reportDoe) {
        Array.from(reportDoe.options).forEach((opt) => {
          opt.selected = doe.map(String).includes(opt.value);
        });
      }
      reportDialog?.showModal();
    });
  });

  reportDialog?.addEventListener('close', () => {
    editingReportId = null;
    reportForm.reset();
    doePicker.style.display = 'none';
  });
  const generateReportBtn = document.getElementById('generateReportBtn');
  generateReportBtn?.addEventListener('click', async () => {
    if (!reportForm) return;
    const formData = new FormData(reportForm);
    const includes = formData.getAll('include').map((val) => String(val));
    const name = String(formData.get('name') || '').trim();
    const executors = String(formData.get('executors') || '').trim();
    const doeIds = formData.getAll('doe_ids').map((val) => String(val)).filter(Boolean);
    const payload = new URLSearchParams();
    if (name) payload.set('name', name);
    if (executors) payload.set('executors', executors);
    includes.forEach((val) => payload.append('include', val));
    doeIds.forEach((val) => payload.append('doe_ids', val));
    const url = editingReportId
      ? `/experiments/<%= experiment.id %>/reports/${editingReportId}`
      : `/experiments/<%= experiment.id %>/reports`;
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: payload
    });
    if (!resp.ok) return;
    const data = await resp.json();
    if (data?.url) window.location.href = data.url;
  });
</script>
<%- include('partials/foot') %>
